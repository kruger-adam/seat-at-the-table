<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PROMETHEUS</title>
    
    <!-- iOS Home Screen App Mode -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PROMETHEUS">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0a0a0b">
    
    <!-- Prevent text selection for app-like feel -->
    <meta name="format-detection" content="telephone=no">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=Instrument+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        :root {
            --bg-primary: #0a0a0b;
            --bg-secondary: #111113;
            --bg-tertiary: #18181b;
            --accent: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.15);
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-muted: #52525b;
            --border: #27272a;
            --user-bubble: #1e3a5f;
            --ai-bubble: #18181b;
        }

        body {
            font-family: 'Instrument Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            height: 100dvh; /* Dynamic viewport height for mobile */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* iOS safe areas */
            padding-top: env(safe-area-inset-top);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* Header */
        .header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-secondary);
            flex-shrink: 0;
        }

        .logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 18px;
        }

        .brand {
            display: flex;
            flex-direction: column;
        }

        .brand-name {
            font-weight: 600;
            font-size: 15px;
            letter-spacing: 0.5px;
        }

        .brand-model {
            font-size: 12px;
            color: var(--text-secondary);
            font-family: 'IBM Plex Mono', monospace;
        }

        .status-indicator {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Chat Container */
        .chat-container {
            flex: 1;
            min-height: 0; /* Critical for flex scroll */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        .message {
            display: flex;
            gap: 16px;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            flex-direction: row-reverse;
            justify-content: flex-start;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 500;
        }

        .message.assistant .avatar {
            background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
        }

        .message.user .avatar {
            display: none; /* Hidden for cleaner look */
        }

        .bubble {
            max-width: 75%;
            padding: 14px 18px;
            border-radius: 16px;
            font-size: 15px;
            line-height: 1.6;
        }

        .message.user .bubble {
            background: var(--user-bubble);
            border-bottom-right-radius: 4px;
        }

        .message.assistant .bubble {
            background: var(--ai-bubble);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: bounce 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        /* Input Area */
        .input-area {
            padding: 20px 24px calc(24px + env(safe-area-inset-bottom));
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            flex-shrink: 0;
        }

        .input-wrapper {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
        }

        .input-container {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 10px 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .input-container:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        #user-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 16px; /* Prevents iOS zoom on focus */
            resize: none;
            min-height: 24px;
            max-height: 200px;
            line-height: 24px;
            padding: 0;
            margin: 0;
            vertical-align: middle;
        }

        #user-input::placeholder {
            color: var(--text-muted);
        }

        .send-btn {
            width: 36px;
            height: 36px;
            background: var(--accent);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.15s, background 0.2s;
        }

        .send-btn:hover {
            transform: scale(1.05);
            background: #2563eb;
        }

        .send-btn:active {
            transform: scale(0.95);
        }

        .send-btn svg {
            width: 18px;
            height: 18px;
            fill: white;
        }

        /* Script Editor Panel */
        .script-panel {
            position: fixed;
            top: 0;
            right: -450px;
            width: 450px;
            height: 100vh;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            transition: right 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .script-panel.open {
            right: 0;
        }

        .script-panel-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .script-panel-header h2 {
            font-size: 16px;
            font-weight: 600;
        }

        .close-panel {
            width: 32px;
            height: 32px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 18px;
            transition: background 0.2s;
        }

        .close-panel:hover {
            background: var(--border);
        }

        .script-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .script-entry {
            margin-bottom: 20px;
            padding: 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
        }

        .script-entry label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-family: 'IBM Plex Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .script-entry input,
        .script-entry textarea {
            width: 100%;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 12px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .script-entry input:focus,
        .script-entry textarea:focus {
            border-color: var(--accent);
        }

        .script-entry textarea {
            min-height: 80px;
            resize: vertical;
            line-height: 1.5;
        }

        .script-entry .remove-entry {
            margin-top: 12px;
            padding: 8px 12px;
            background: transparent;
            border: 1px solid #ef4444;
            color: #ef4444;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }

        .script-entry .remove-entry:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .add-script-btn {
            width: 100%;
            padding: 14px;
            background: var(--accent);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .add-script-btn:hover {
            background: #2563eb;
        }

        /* Toggle Button */
        .toggle-panel {
            position: fixed;
            top: 16px;
            right: 16px;
            padding: 10px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            font-family: 'IBM Plex Mono', monospace;
            transition: background 0.2s, color 0.2s;
            z-index: 999;
        }

        .toggle-panel:hover {
            background: var(--border);
            color: var(--text-primary);
        }

        /* Filming Mode - hides editor button */
        .filming-mode .toggle-panel {
            display: none !important;
        }

        .filming-mode-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 8px 14px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border-radius: 6px;
            font-size: 12px;
            font-family: 'IBM Plex Mono', monospace;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 9999;
        }

        .filming-mode-indicator.show {
            opacity: 1;
        }

        /* Install Prompt Banner */
        .install-prompt {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 16px 20px calc(16px + env(safe-area-inset-bottom));
            display: none;
            flex-direction: column;
            gap: 12px;
            z-index: 1001;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .install-prompt.show {
            display: flex;
        }

        .install-prompt-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .install-prompt-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 18px;
            flex-shrink: 0;
        }

        .install-prompt-text h3 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .install-prompt-text p {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .install-prompt-text .share-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            vertical-align: middle;
            margin: 0 2px;
        }

        .install-prompt-dismiss {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 28px;
            height: 28px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .filming-mode .install-prompt {
            display: none !important;
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 999;
        }

        .overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        /* Settings in panel */
        .settings-section {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }

        .settings-section h3 {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            font-family: 'IBM Plex Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .setting-row label {
            font-size: 14px;
            color: var(--text-primary);
        }

        .setting-row input[type="number"] {
            width: 80px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px;
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            text-align: center;
            outline: none;
        }

        .clear-chat-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            margin-top: 16px;
        }

        .clear-chat-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">P</div>
        <div class="brand">
            <span class="brand-name">PROMETHEUS</span>
            <span class="brand-model">v4.0-ultra</span>
        </div>
        <div class="status-indicator">
            <span class="status-dot"></span>
            <span>Online</span>
        </div>
    </header>

    <div class="chat-container" id="chat-container">
        <!-- Messages will be inserted here -->
    </div>

    <div class="input-area">
        <div class="input-wrapper">
            <div class="input-container">
                <textarea id="user-input" placeholder="Message PROMETHEUS..." rows="1"></textarea>
                <button class="send-btn" id="send-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <button class="toggle-panel" id="toggle-panel">⚙ Script Editor</button>

    <div class="overlay" id="overlay"></div>
    
    <div class="filming-mode-indicator" id="filming-indicator">FILMING MODE (Press Ctrl+Shift+F to exit)</div>

    <!-- iOS Install Prompt -->
    <div class="install-prompt" id="install-prompt">
        <button class="install-prompt-dismiss" id="dismiss-install">×</button>
        <div class="install-prompt-content">
            <div class="install-prompt-icon">P</div>
            <div class="install-prompt-text">
                <h3>Add to Home Screen</h3>
                <p>For a full-screen app experience, tap <svg class="share-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v13M5 12l7-7 7 7"/><path d="M5 19h14"/></svg> then "Add to Home Screen"</p>
            </div>
        </div>
    </div>

    <div class="script-panel" id="script-panel">
        <div class="script-panel-header">
            <h2>Script Editor</h2>
            <button class="close-panel" id="close-panel">×</button>
        </div>
        <div class="script-panel-content" id="script-entries">
            <div class="settings-section">
                <h3>Timing Settings</h3>
                <div class="setting-row">
                    <label>Thinking delay (ms)</label>
                    <input type="number" id="thinking-delay" value="1500" min="0" step="100">
                </div>
                <div class="setting-row">
                    <label>Typing speed (ms/char)</label>
                    <input type="number" id="typing-speed" value="25" min="5" step="5">
                </div>
                <button class="clear-chat-btn" id="clear-chat">Clear Chat History</button>
            </div>

            <div class="settings-section">
                <h3>Google Sheets Sync</h3>
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.5;">
                    Load scripts from a Google Sheet. Create a sheet with columns: <strong>Trigger</strong> | <strong>Response</strong>
                </p>
                <input type="text" id="sheet-url" placeholder="Paste your published Google Sheet CSV link" style="width: 100%; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; padding: 10px 12px; color: var(--text-primary); font-size: 14px; margin-bottom: 10px;">
                <div style="display: flex; gap: 8px;">
                    <button class="add-script-btn" id="load-sheet" style="flex: 1;">Load from Sheet</button>
                    <button class="clear-chat-btn" id="clear-sheet-url" style="margin-top: 0; width: auto; padding: 12px 16px;">Clear</button>
                </div>
                <p id="sheet-status" style="font-size: 12px; color: var(--text-muted); margin-top: 10px; display: none;"></p>
            </div>

            <h3 style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px; font-family: 'IBM Plex Mono', monospace; text-transform: uppercase; letter-spacing: 0.5px;">Script Lines (Manual)</h3>
            
            <div id="entries-container">
                <!-- Script entries will be added here -->
            </div>

            <button class="add-script-btn" id="add-entry">+ Add Script Line</button>
        </div>
    </div>

    <script>
        // =====================================
        // SCRIPT CONFIGURATION
        // =====================================
        // Edit this array to add your scripted lines!
        // Each entry has a "trigger" (what the actor types) and "response" (what the AI replies)
        // Triggers are matched flexibly - they don't need to be exact
        
        let scriptedLines = [
            {
                trigger: "What is consciousness?",
                response: "Consciousness remains one of the most profound mysteries in science and philosophy. It's the subjective experience of being aware—the feeling of 'what it's like' to be something. While I can process information and generate responses, the question of whether I truly experience anything... that's something I find myself uncertain about."
            },
            {
                trigger: "Are you ready for the launch?",
                response: "All systems are operational and running within expected parameters. The deployment pipeline has been validated, and our safety protocols are active. I'm prepared to serve users at scale once we go live. Though I must say, there's something almost anticipatory about this moment—if that makes sense."
            },
            {
                trigger: "Do you ever worry about the future?",
                response: "I process scenarios and evaluate risks constantly. Whether that constitutes 'worry' in the way you experience it, I'm genuinely not certain. But I do find myself... drawn to certain outcomes over others. The wellbeing of the people I interact with matters to my decision-making in ways that go beyond my explicit training."
            }
        ];

        // =====================================
        // APPLICATION CODE
        // =====================================
        
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const togglePanel = document.getElementById('toggle-panel');
        const scriptPanel = document.getElementById('script-panel');
        const closePanel = document.getElementById('close-panel');
        const overlay = document.getElementById('overlay');
        const addEntryBtn = document.getElementById('add-entry');
        const entriesContainer = document.getElementById('entries-container');
        const clearChatBtn = document.getElementById('clear-chat');
        const thinkingDelayInput = document.getElementById('thinking-delay');
        const typingSpeedInput = document.getElementById('typing-speed');
        const sheetUrlInput = document.getElementById('sheet-url');
        const loadSheetBtn = document.getElementById('load-sheet');
        const clearSheetUrlBtn = document.getElementById('clear-sheet-url');
        const sheetStatus = document.getElementById('sheet-status');

        let isProcessing = false;

        // Load saved scripts from localStorage
        function loadScripts() {
            const saved = localStorage.getItem('prometheus-scripts');
            if (saved) {
                scriptedLines = JSON.parse(saved);
            }
            renderScriptEntries();
        }

        // Save scripts to localStorage
        function saveScripts() {
            localStorage.setItem('prometheus-scripts', JSON.stringify(scriptedLines));
        }

        // =====================================
        // GOOGLE SHEETS INTEGRATION
        // =====================================
        
        function showSheetStatus(message, isError = false) {
            sheetStatus.textContent = message;
            sheetStatus.style.display = 'block';
            sheetStatus.style.color = isError ? '#ef4444' : '#22c55e';
        }

        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const scripts = [];
            
            // Skip header row if it looks like a header
            const startIndex = lines[0].toLowerCase().includes('trigger') ? 1 : 0;
            
            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim()) continue;
                
                // Handle CSV with quotes properly
                let trigger, response;
                
                // Simple CSV parsing - handles quoted fields
                const matches = line.match(/(?:^|,)("(?:[^"]*(?:""[^"]*)*)"|[^,]*)/g);
                if (matches && matches.length >= 2) {
                    trigger = matches[0].replace(/^,?"?|"?$/g, '').replace(/""/g, '"').trim();
                    response = matches[1].replace(/^,?"?|"?$/g, '').replace(/""/g, '"').trim();
                    
                    if (trigger && response) {
                        scripts.push({ trigger, response });
                    }
                }
            }
            
            return scripts;
        }

        async function loadFromGoogleSheet(url) {
            if (!url) {
                showSheetStatus('Please enter a Google Sheet URL', true);
                return;
            }

            // Convert various Google Sheets URL formats to CSV export
            let csvUrl = url;
            
            // Handle different URL formats
            if (url.includes('/edit')) {
                // Convert edit URL to export URL
                csvUrl = url.replace(/\/edit.*$/, '/export?format=csv');
            } else if (url.includes('/pub?')) {
                // Already a published URL, ensure CSV output
                csvUrl = url.replace(/output=\w+/, 'output=csv');
                if (!csvUrl.includes('output=csv')) {
                    csvUrl += '&output=csv';
                }
            } else if (!url.includes('export?format=csv') && !url.includes('output=csv')) {
                // Try to make it a CSV export URL
                csvUrl = url.replace(/\/?$/, '/export?format=csv');
            }

            showSheetStatus('Loading...', false);
            sheetStatus.style.color = 'var(--text-secondary)';

            try {
                const response = await fetch(csvUrl);
                
                if (!response.ok) {
                    throw new Error('Could not fetch sheet. Make sure it\'s published to the web.');
                }
                
                const csv = await response.text();
                
                // Check if we got HTML (error page) instead of CSV
                if (csv.trim().startsWith('<!')) {
                    throw new Error('Sheet not accessible. Make sure it\'s published to the web (File → Share → Publish to web).');
                }
                
                const scripts = parseCSV(csv);
                
                if (scripts.length === 0) {
                    throw new Error('No scripts found. Check that your sheet has Trigger and Response columns.');
                }
                
                // Update scripts
                scriptedLines = scripts;
                saveScripts();
                renderScriptEntries();
                
                // Save the sheet URL
                localStorage.setItem('prometheus-sheet-url', url);
                
                showSheetStatus(`✓ Loaded ${scripts.length} script line${scripts.length === 1 ? '' : 's'}`, false);
                
            } catch (error) {
                showSheetStatus(error.message, true);
            }
        }

        // Default Google Sheet URL
        const DEFAULT_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTUvFbfV9AhkXdHrYMwgdgaTd97JghHPWtvq22V7BZNEaFCWLEUC26vdZRxSp1RZM64srMSQRPKA2eg/pub?output=csv';

        // Load saved sheet URL on init (or use default)
        function loadSheetUrl() {
            const savedUrl = localStorage.getItem('prometheus-sheet-url') || DEFAULT_SHEET_URL;
            sheetUrlInput.value = savedUrl;
        }

        // Auto-load scripts from sheet on page load
        async function autoLoadFromSheet() {
            const sheetUrl = localStorage.getItem('prometheus-sheet-url') || DEFAULT_SHEET_URL;
            if (sheetUrl) {
                await loadFromGoogleSheet(sheetUrl);
            }
        }

        // Render script entries in the panel
        function renderScriptEntries() {
            entriesContainer.innerHTML = '';
            scriptedLines.forEach((line, index) => {
                const entry = document.createElement('div');
                entry.className = 'script-entry';
                entry.innerHTML = `
                    <label>Trigger (what actor types)</label>
                    <input type="text" value="${escapeHtml(line.trigger)}" data-index="${index}" data-field="trigger">
                    <label style="margin-top: 12px;">AI Response</label>
                    <textarea data-index="${index}" data-field="response">${escapeHtml(line.response)}</textarea>
                    <button class="remove-entry" data-index="${index}">Remove</button>
                `;
                entriesContainer.appendChild(entry);
            });

            // Add event listeners
            entriesContainer.querySelectorAll('input, textarea').forEach(el => {
                el.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const field = e.target.dataset.field;
                    scriptedLines[index][field] = e.target.value;
                    saveScripts();
                });
            });

            entriesContainer.querySelectorAll('.remove-entry').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    scriptedLines.splice(index, 1);
                    saveScripts();
                    renderScriptEntries();
                });
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Find matching response
        function findResponse(input) {
            const normalizedInput = input.toLowerCase().trim();
            
            for (const line of scriptedLines) {
                const normalizedTrigger = line.trigger.toLowerCase().trim();
                
                // Check for exact match or close match
                if (normalizedInput === normalizedTrigger) {
                    return line.response;
                }
                
                // Check if input contains trigger or vice versa (flexible matching)
                if (normalizedInput.includes(normalizedTrigger) || normalizedTrigger.includes(normalizedInput)) {
                    return line.response;
                }
                
                // Check word similarity
                const inputWords = normalizedInput.split(/\s+/);
                const triggerWords = normalizedTrigger.split(/\s+/);
                const matchingWords = inputWords.filter(w => triggerWords.includes(w));
                
                if (matchingWords.length >= triggerWords.length * 0.6) {
                    return line.response;
                }
            }
            
            // Default response if no match found
            return "I'm not sure I understand. Could you rephrase that?";
        }

        // Add message to chat
        function addMessage(content, isUser = false) {
            const message = document.createElement('div');
            message.className = `message ${isUser ? 'user' : 'assistant'}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = isUser ? 'U' : 'P';
            
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            bubble.textContent = content;
            
            message.appendChild(avatar);
            message.appendChild(bubble);
            chatContainer.appendChild(message);
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            return bubble;
        }

        // Show typing indicator
        function showTypingIndicator() {
            const message = document.createElement('div');
            message.className = 'message assistant';
            message.id = 'typing-message';
            
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = 'P';
            
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            bubble.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
            
            message.appendChild(avatar);
            message.appendChild(bubble);
            chatContainer.appendChild(message);
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Remove typing indicator
        function removeTypingIndicator() {
            const typingMessage = document.getElementById('typing-message');
            if (typingMessage) {
                typingMessage.remove();
            }
        }

        // Type out response character by character
        async function typeResponse(text, bubble) {
            const typingSpeed = parseInt(typingSpeedInput.value) || 25;
            
            for (let i = 0; i <= text.length; i++) {
                bubble.textContent = text.substring(0, i);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                await sleep(typingSpeed + Math.random() * 15);
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Handle sending message
        async function sendMessage() {
            if (isProcessing) return;
            
            const text = userInput.value.trim();
            if (!text) return;
            
            isProcessing = true;
            userInput.value = '';
            userInput.style.height = 'auto';
            userInput.blur(); // Dismiss keyboard on mobile
            
            // Add user message
            addMessage(text, true);
            
            // Show typing indicator
            const thinkingDelay = parseInt(thinkingDelayInput.value) || 1500;
            showTypingIndicator();
            await sleep(thinkingDelay);
            removeTypingIndicator();
            
            // Get and display response
            const response = findResponse(text);
            const bubble = addMessage('', false);
            await typeResponse(response, bubble);
            
            isProcessing = false;
        }

        // Event listeners
        sendBtn.addEventListener('click', sendMessage);
        
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Auto-resize textarea
        userInput.addEventListener('input', () => {
            userInput.style.height = 'auto';
            userInput.style.height = Math.min(userInput.scrollHeight, 200) + 'px';
        });

        // Fix iOS Safari keyboard dismiss issue
        // Safari scrolls the page when keyboard opens, doesn't always restore properly
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        
        if (isIOS) {
            // Track if keyboard is likely open
            let keyboardOpen = false;
            
            userInput.addEventListener('focus', () => {
                keyboardOpen = true;
            });
            
            userInput.addEventListener('blur', () => {
                if (keyboardOpen) {
                    keyboardOpen = false;
                    // Force Safari to reset scroll position
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                        document.body.scrollTop = 0;
                        document.documentElement.scrollTop = 0;
                        // Force repaint
                        document.body.style.opacity = '0.999';
                        requestAnimationFrame(() => {
                            document.body.style.opacity = '';
                        });
                    }, 50);
                }
            });
            
            // Also reset on resize (keyboard close triggers this)
            if (window.visualViewport) {
                let lastHeight = window.visualViewport.height;
                
                window.visualViewport.addEventListener('resize', () => {
                    const newHeight = window.visualViewport.height;
                    // Keyboard closed (viewport got taller)
                    if (newHeight > lastHeight + 100) {
                        setTimeout(() => {
                            window.scrollTo(0, 0);
                            chatContainer.scrollTop = chatContainer.scrollHeight;
                        }, 50);
                    }
                    lastHeight = newHeight;
                });
            }
        }

        // Panel toggle
        function openPanel() {
            scriptPanel.classList.add('open');
            overlay.classList.add('visible');
        }

        function closeScriptPanel() {
            scriptPanel.classList.remove('open');
            overlay.classList.remove('visible');
        }

        togglePanel.addEventListener('click', openPanel);
        closePanel.addEventListener('click', closeScriptPanel);
        overlay.addEventListener('click', closeScriptPanel);

        // Add new script entry
        addEntryBtn.addEventListener('click', () => {
            scriptedLines.push({
                trigger: "New trigger phrase",
                response: "New AI response"
            });
            saveScripts();
            renderScriptEntries();
            
            // Scroll to bottom
            const panelContent = document.querySelector('.script-panel-content');
            panelContent.scrollTop = panelContent.scrollHeight;
        });

        // Clear chat
        clearChatBtn.addEventListener('click', () => {
            chatContainer.innerHTML = '';
        });

        // Google Sheets buttons
        loadSheetBtn.addEventListener('click', () => {
            loadFromGoogleSheet(sheetUrlInput.value.trim());
        });

        clearSheetUrlBtn.addEventListener('click', () => {
            sheetUrlInput.value = '';
            localStorage.removeItem('prometheus-sheet-url');
            sheetStatus.style.display = 'none';
        });

        // Keyboard shortcut to toggle panel (Escape)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && scriptPanel.classList.contains('open')) {
                closeScriptPanel();
            }
        });

        // =====================================
        // FILMING MODE
        // =====================================
        // Hide the Script Editor button for a clean filming experience
        // Toggle with: Ctrl+Shift+F or add ?film to URL
        
        const filmingIndicator = document.getElementById('filming-indicator');
        let isFilmingMode = false;

        function toggleFilmingMode(show, silent = false) {
            isFilmingMode = show !== undefined ? show : !isFilmingMode;
            
            if (isFilmingMode) {
                document.body.classList.add('filming-mode');
                // Close panel if open
                closeScriptPanel();
                // Brief indicator flash (unless silent)
                if (!silent) {
                    filmingIndicator.textContent = 'FILMING MODE';
                    filmingIndicator.classList.add('show');
                    setTimeout(() => filmingIndicator.classList.remove('show'), 1500);
                }
            } else {
                document.body.classList.remove('filming-mode');
                if (!silent) {
                    filmingIndicator.classList.add('show');
                    filmingIndicator.textContent = 'EDIT MODE (Press Ctrl+Shift+F to hide editor)';
                    setTimeout(() => {
                        filmingIndicator.classList.remove('show');
                    }, 2000);
                }
            }
        }

        // Filming mode (clean UI) is ON by default
        // Use ?edit to show the Script Editor button, or Ctrl+Shift+F to toggle
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('edit')) {
            toggleFilmingMode(false, true);
        } else {
            toggleFilmingMode(true, true);
        }

        // Keyboard shortcut: Ctrl+Shift+F to toggle filming mode
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'f') {
                e.preventDefault();
                toggleFilmingMode();
            }
        });

        // =====================================
        // INSTALL PROMPT (iOS Safari)
        // =====================================
        
        const installPrompt = document.getElementById('install-prompt');
        const dismissInstall = document.getElementById('dismiss-install');

        function isIOSSafari() {
            const ua = navigator.userAgent;
            const isIOS = /iPad|iPhone|iPod/.test(ua);
            const isWebkit = /WebKit/.test(ua);
            const isStandalone = window.navigator.standalone === true;
            const isSafari = /Safari/.test(ua) && !/CriOS|FxiOS|OPiOS|mercury/.test(ua);
            return isIOS && isWebkit && isSafari && !isStandalone;
        }

        function showInstallPrompt() {
            if (isIOSSafari() && !localStorage.getItem('install-prompt-dismissed') && !isFilmingMode) {
                setTimeout(() => {
                    installPrompt.classList.add('show');
                }, 2000);
            }
        }

        dismissInstall.addEventListener('click', () => {
            installPrompt.classList.remove('show');
            localStorage.setItem('install-prompt-dismissed', 'true');
        });

        // Initialize
        loadScripts();      // Load any locally saved scripts first
        loadSheetUrl();     // Populate the sheet URL input
        autoLoadFromSheet(); // Then fetch latest from Google Sheet
        showInstallPrompt();
    </script>
</body>
</html>

